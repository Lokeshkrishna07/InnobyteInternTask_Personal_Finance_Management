{% extends "base.html" %}
{% block title %}Transactions · Finance Tracker{% endblock %}
{% block content %}
<h2>Transactions</h2>

<div class="grid">
  <div class="card">
    <h3>Add Category</h3>
    <form class="form inline" id="catForm">
      <input name="name" placeholder="e.g., Food" required>
      <select name="type"><option value="expense">Expense</option><option value="income">Income</option></select>
      <button class="btn" type="submit">Add</button>
    </form>
    <div class="table-wrap">
      <table class="table" id="catTable">
        <thead><tr><th>ID</th><th>Name</th><th>Type</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h3>Add Transaction</h3>
    <form class="form" id="txForm">
      <div class="row">
        <input name="amount" type="number" step="0.01" placeholder="Amount" required>
        <select name="type"><option value="expense">Expense</option><option value="income">Income</option></select>
      </div>
      <div class="row">
        <select name="category_id" id="categorySelect" required>
          <option value="">Select category…</option>
        </select>
        <input name="date" type="date">
      </div>
      <input name="description" placeholder="Description (optional)">
      <button class="btn primary" type="submit">Create</button>
    </form>
    <div id="budgetNote" class="hint"></div>
  </div>
</div>

<div class="card">
  <div class="toolbar">
    <h3>Recent Transactions</h3>
    <div>
      <button class="btn" id="refresh">Refresh</button>
    </div>
  </div>
  <div class="table-wrap">
    <table class="table" id="txTable">
      <thead>
        <tr><th>Date</th><th>Type</th><th>Amount</th><th>Category</th><th>Description</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
async function loadCategories() {
  const res = await fetch('/api/categories/');
  const cats = await res.json();
  const sel = document.getElementById('categorySelect');
  const tbody = document.querySelector('#catTable tbody');
  sel.innerHTML = '<option value="">Select category…</option>';
  tbody.innerHTML = '';
  cats.forEach(c => {
    sel.insertAdjacentHTML('beforeend', `<option value="${c.id}">${c.name} (${c.type})</option>`);
    tbody.insertAdjacentHTML('beforeend', `<tr><td>${c.id}</td><td>${c.name}</td><td>${c.type}</td></tr>`);
  });
}

async function loadTransactions() {
  const res = await fetch('/api/transactions/');
  const txs = await res.json();
  const tbody = document.querySelector('#txTable tbody');
  tbody.innerHTML = '';
  txs.forEach(t => {
    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${t.date}</td>
        <td class="${t.type}">${t.type}</td>
        <td>₹ ${(+t.amount).toFixed(2)}</td>
        <td>${t.category_id}</td>
        <td>${t.description || ""}</td>
        <td><button class="btn danger sm" data-id="${t.id}" onclick="delTx(${t.id})">Delete</button></td>
      </tr>
    `);
  });
}

async function delTx(id) {
  const res = await fetch('/api/transactions/' + id, {method:'DELETE'});
  if(res.ok){ toast('Transaction deleted'); loadTransactions(); }
  else { toast('Failed to delete', 'error'); }
}

document.getElementById('catForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const f = e.target;
  const res = await fetch('/api/categories/', {method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({name:f.name.value, type:f.type.value})});
  const j = await res.json();
  if(res.ok){ toast('Category added'); f.reset(); loadCategories(); }
  else { toast(j.error || 'Failed to add category', 'error'); }
});

document.getElementById('txForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const f = e.target;
  const payload = {
    amount: f.amount.value,
    category_id: f.category_id.value,
    type: f.type.value,
    date: f.date.value,
    description: f.description.value
  };
  const res = await fetch('/api/transactions/', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  const j = await res.json();
  if(res.ok){
    toast('Transaction added');
    if(j.budget){
      const b = j.budget;
      const note = `Budget ${b.category}: Spent ₹${b.spent} / Limit ₹${b.limit} ${b.is_over ? '— OVER!' : ''}`;
      document.getElementById('budgetNote').textContent = note;
      if(b.is_over) toast('Budget exceeded for ' + b.category, 'error');
    }
    f.reset();
    loadTransactions();
  } else {
    toast(j.error || 'Failed to add transaction', 'error');
  }
});

document.getElementById('refresh').addEventListener('click', loadTransactions);
loadCategories();
loadTransactions();
</script>
{% endblock %}
